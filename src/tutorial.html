<div id="project-content" class="d-flex flex-column h-100">
    <div class="viewer-container">
        <div id="viewer" class="h-100">
        </div>
    </div>
</div>
<script>
    // Setup the viewer
    var lcViewerInterface = new LibCrowdsViewerInterface({ 
        id: 'viewer', 
        selectionEnabled: true,
        confirmBeforeLeaving: false,
        taskInputConfig: {
            title: 'Task',
            answerButtonText: 'Get Started',
            showProgress: false,
            showFavourites: false,
            showTutorial: false,
            showComments: false,
            showPreview: false
        }
    });
    
    
    // Load an example task
    lcViewerInterface.loadTask({
        id: 1,
        info: {
            objective: 'Identify each title',
            guidance: 'Draw a rectangle around the title of each play.',
            image_ark: 'ark:/81055/vdc_100022589157.0x000016',
            manifest_url: 'http://api.bl.uk/metadata/iiif/ark:/81055/vdc_100022589158.0x000002/manifest.json'
        }
    });
    
    
    // Define the tour
    var tour = new Shepherd.Tour({
        defaults: {
            classes: 'shepherd-theme-arrows'
        }
    });
    
    tour.addStep('toggle', {
        title: 'Toggle Selection',
        text: 'Click this button to toggle area selection.',
        attachTo: {
            element: '#toggle-selection',
            on: 'right'
        },
        buttons: [
            {
                text: 'Next',
                action: function() {
                    tour.next();
                    lcViewerInterface.selector.enable();
                }
            }
        ]
    });
    
    tour.addStep('draw', {
        title: 'Select an Area',
        text: 'Select an area of the image.',
        buttons: [
            {
                text: 'Try it',
                action: tour.hide
            }
        ]
    });
    
    tour.addStep('edit', {
        title: 'Edit a Selection',
        text: 'Click on a previously selected area to edit it.',
        attachTo: {
            element: '.selection-overlay',
            on: 'left'
        },
        buttons: [
            {
                text: 'Try it',
                action: tour.hide
            }
        ]
    });
    
    tour.addStep('start', {
        title: 'Start',
        text: "When you're ready, click here to get started.",
        attachTo: {
            element: '.viewer-sidebar',
            on: 'left'
        },
        buttons: null
    });
    
    lcViewerInterface.viewer.addHandler('selection_toggle', function(evt) {
        if (evt.enabled && tour.getCurrentStep().id === 'toggle') {
            tour.next();
        }
    });
    
    lcViewerInterface.viewer.addHandler('selection', function(evt) {
        if (tour.getCurrentStep().id === 'draw') {
            tour.next();
        }
    });
    
    $(document).on("DOMNodeRemoved", function (evt) {
        if ($(evt.target).hasClass('selection-overlay') && tour.getCurrentStep().id === 'edit') {
            lcViewerInterface.viewer.addHandler('selection', tour.next);
            lcViewerInterface.viewer.addHandler('selection_cancel', tour.next);
        }
    });
    
    // Start tour after the image loads
    lcViewerInterface.viewer.addHandler('open', function() {
        tour.start();
    });
    
    $('.btn-answer').off('click').on('click', function() {
        window.location.pathname = 'project/{{ short_name }}/newtask';
    });
</script>