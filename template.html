<link type="text/css" rel="stylesheet" href="https://annotorious.github.io/latest/themes/dark/annotorious-dark.css"/>
<style>
    #openseadragon {
        width: 100%;
        height: 600px;
        background-color: #000;
    }
</style>
<div class="row skeleton">

    <!-- Image column -->
    <div class="col-xs-12 col-sm-8">
        <div id="openseadragon"></div>
    </div>
	
  	<!-- Question and answer column -->
    <div class="col-xs-12 col-sm-4">
        <div class="row">
            <div class="col-xs-12">
                <p class="lead">Please mark each play</p>
            </div>
      	</div>
        <hr>
        <div class="row">
            <div class="col-xs-12 text-center">
                <div id="annotation-fields"></div>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-xs-6 text-right">
                <a href="../tutorial" class="btn btn-inverse"><span class="fa fa-book"></span> Tutorial</a>
            </div>
            <div class="col-xs-6 text-left">
                <a href="#comments" id="comments-btn" class="btn btn-inverse" data-toggle="collapse"><span class="fa fa-plus"></span>Comment</a>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                <div class="collapse" id="comments">
                    <textarea id="comments" class="form-control" rows="5" placeholder="Comments"></textarea>
                </div>
            </div>
        </div>
      <div class="row">
        <div class="col-xs-6 col-xs-offset-3 text-center">
            <button class="btn btn-success btn-answer"><span class="fa fa-thumbs-o-up"></span> Done</button>
        </div>
      </div>
      
      
      <hr>
      
      
      <!-- Feedback items for the user -->
		<div class="text-center">
		    <p>You are working on task: <span class="label label-default" id="task-id">#</span></p>
		</div>

       
    </div>
</div>

<script type="text/javascript" src="https://cdn.rawgit.com/LibCrowds/project-crop-images/df314d2e/assets/openseadragon-2.2.1/openseadragon.min.js"></script>
<script type="text/javascript" src="https://annotorious.github.io/latest/annotorious.min.js"></script>
<script>
    // Setup the OpenSeadragon viewer.
    const viewer = OpenSeadragon({
        id: "openseadragon",
        prefixUrl: "https://cdn.rawgit.com/LibCrowds/project-crop-images/df314d2e/assets/openseadragon-2.2.1/images/",
        defaultZoomLevel: 0.9
    });
    anno.makeAnnotatable(viewer);
    
    /** Clear the comments box. */
    function resetComments() {
        $('#comments').removeClass('in');
        $('#comments').val('');
    }
    
    /** Load an image into the viewer. */
    function loadImage(imageURL) {
        viewer.open({
            type: 'image',
            url:  imageURL,
            buildPyramid: false
        });
    }
    
    /** Load previous annotations. */
    function loadAnnotations(task) {
        let annotations = [];
        $.ajax({
            url: '/api/taskrun',
            data: `all=1?task_id=${task.id}`,
            dataType: 'json'
        }).done(function(taskRuns) {
            for (let i = 0; i < taskRuns.length; i++) {
                let trAnnotations = taskRuns[i].info.annotations;
                for (let i = 0; i < trAnnotations; i++) {
                    annotations.push($.JSON.parse(trAnnotations[i]));
                }
            }
            for (let i = 0; i < annotations.length; i++) {
                anno.add(annotations[i]);
            }
        });
    }
    
    /** Setup annotation buttons. */
    function setupButtons(task) {
        const fields = task.info.fields || ['annotation'];
        $('#annotation-fields').html('');
        for (let i = 0; i < fields.length; i++) {
            $('#annotation-fields').append(`<button id="${fields[i]}-annotation" class="btn btn-default annotation">${fields[i]}</button>`);
        }
        
        $('.annotation').on('click', function() {
            anno.activateSelector();
        });
    }
  
   /** Load the image. */
    pybossa.taskLoaded(function(task, deferred) {
        if (!$.isEmptyObject(task)) {
            loadImage(task.info.url_b);
            viewer.addHandler('tile-loaded', function() {
                setupButtons(task);
                loadAnnotations(task);
                deferred.resolve(task);
            });
        } else {
            deferred.resolve(task);
        }
    });
  
    /** Present the task. */
    pybossa.presentTask(function(task, deferred) {
        if (!$.isEmptyObject(task)) {
          	resetComments();
            $('#task-id').html(task.id);
            $('.btn-answer').off('click').on('click', function() {
                task.answer = {
                    annotations: anno.getAnnotations()
                };
                console.log(task.answer);
                pybossa.saveTask(task.id, task.answer).done(function() {
                    deferred.resolve();
                    pybossaNotify('Answer saved!', 'success', true);
                }).fail(function(xhr, status, error) {
                    pybossaLogError(new Error(error));
                });
            });
        } else {
          $(".skeleton").hide();
          $('image-container').hide();
          pybossaNotify('Congratulations! You have contributed to all available tasks!', 'success');
        }
    });
    pybossa.run('marktest');
</script>
