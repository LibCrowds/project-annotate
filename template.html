<style>
    #openseadragon {
        height: 60vh;
        background-color: #000000;
    }
    #answer-column {
        overflow-y: auto;
    }
    .popover { 
        max-width:600px !important; 
    }
    .overlay,
    .selection-box {
        border: 2px solid #FD953A !important;
    }
    .overlay {
        opacity: .75;
    }
    .hud,
    .overlay:hover,
    .overlay:focus,
    .tooltip.tooltip-hud .tooltip-inner {
        background-color: rgba(0, 0, 0, 0.5);
    }
    .hud {
        position: absolute;
        z-index: 2;
        border-radius: 2.5rem;
    }
    .btn-hud {
        background: none;
        color: #fff;
        opacity: 0.65;
        text-shadow: 0 0 5px #000;
        font-size: 1.25rem;
        padding: .5rem;
    }
    .btn-hud:hover,
    .btn-hud:focus {
        opacity: 1;
    }
    .tooltip.tooltip-hud .tooltip-inner:before {
        border-right-color: rgba(0, 0, 0, 0.5);
    }
    @media (min-width: 768px) {
        #openseadragon {
            height: 100%;
        }
    }
</style>

<div id="project-content" class="bg-faded container-fluid d-flex flex-column h-100">
    <div class="row h-100">

        <!-- Viewer column -->
        <div class="col-sm-12 col-md-9 px-0">
            <div class="hud ml-2 mt-2 d-flex flex-column">
                <button id="zoom-in" class="btn btn-hud" data-toggle="tooltip" role="button">
                    <span class="fa fa-plus-circle"></span>
                </button>
                <button id="zoom-out" class="btn btn-hud" data-toggle="tooltip" role="button">
                    <span class="fa fa-minus-circle"></span>
                </button>
                <button id="home" class="btn btn-hud" data-toggle="tooltip" role="button">
                    <span class="fa fa-refresh"></span>
                </button>
                <button id="full-page" class="btn btn-hud" data-toggle="tooltip" role="button">
                    <span class="fa fa-expand"></span>
                </button>
                <button id="image-quality" class="btn btn-hud" data-toggle="tooltip" title="Image quality" role="button">
                    <span class="fa fa-cog"></span>
                </button>
                <button id="toggle-selection" class="btn btn-hud" data-toggle="tooltip" title="Toggle selection" role="button">
                    <span class="fa fa-toggle-on"></span>
                </button>
            </div>
            <div id="openseadragon"></div> 
        </div>

        <!-- Question and answer column -->
        <div id="answer-column" class="col-sm-12 col-md-3 py-3">
            <div class="card card-block text-left mb-2">
                <p id="question" class="lead text-center"></h3>
                <p id="help"></p>
                <button id="example" class="btn btn-secondary btn-sm mt-2" data-toggle="popover" title="Example" alt="Example Selection" role="button">
                    Show Example
                </button>
                <a href="../tutorial" class="btn btn-secondary btn-sm mt-1" role="button">View Tutorial</a>
            </div>
            <div class="text-center">
			    <button class="btn btn-success btn-sm btn-answer mt-2"><span class="fa fa-floppy-o mr-1"></span>Save</button>
                <hr>
                <p class="mt-2 mb-1">
                    <span class="fa-stack mr-1">
                      <i class="fa fa-circle fa-stack-2x"></i>
                      <i class="fa fa-trophy fa-stack-1x fa-inverse"></i>
                    </span><span id="rank"></span>
                    <span class="fa-stack ml-3 mr-1">
                      <i class="fa fa-circle fa-stack-2x"></i>
                      <i class="fa fa-tasks fa-stack-1x fa-inverse"></i>
                    </span><span id="score"></span>
                </p>
                <p class="mb-0"><small>You are working on task #<span id="task-id"></span></small></p>
            </div>
        </div>
    </div>
</div>



<script>
    let overlayID = 1,
        overlays = {};

    // Setup viewer
    OpenSeadragon.setString("Tooltips.FullPage", "Fullscreen");
    OpenSeadragon.setString("Tooltips.Home", "Reset zoom");
    OpenSeadragon.setString("Tooltips.SelectionToggle", "Toggle Selection");
    OpenSeadragon.setString("Tooltips.SelectionConfirm", "Confirm Selection");
    const viewer = OpenSeadragon({
        id: "openseadragon",
        prefixUrl: "/static/img/openseadragon/",
        zoomInButton:   "zoom-in",
        zoomOutButton:  "zoom-out",
        homeButton:     "home",
        fullPageButton: "full-page",
        showNavigator: true,
        navigatorPosition: 'BOTTOM_RIGHT',
        homeFillsViewer: true,
        minZoomLevel: 0.1,
        showReferenceStrip: true,
        referenceStripScroll: 'vertical',
        gestureSettingsMouse: {
            clickToZoom: false
        },
        gestureSettingsTouch: {
            clickToZoom: false
        },
        gestureSettingsPen: {
            clickToZoom: false
        }
    });

    // Setup selector
    const selector = viewer.selection({
        prefixUrl: "/static/img/openseadragonselection/",
        restrictToImage: true,
        toggleButton: document.getElementById('toggle-selection')
    });
    selector.enable();
    $('.confirm-button, .cancel-button').addClass('btn btn-hud');
    $('.confirm-button, .cancel-button').attr('role', 'button');
    $('.confirm-button').html('<span class="fa fa-home"></span>')
    
    // Setup tooltips
    $('.btn-hud[data-toggle="tooltip"]').tooltip({
        placement: 'right',
        template: `<div class="tooltip tooltip-hud" role="tooltip"><div class="tooltip-arrow"></div>
                  <div class="tooltip-inner"></div></div>`
    });

    /**
     * Load an image into the viewer.
     */
    function loadImage(imageArk) {
        const url = `http://api.bl.uk/image/iiif/${imageArk}/full/full/0/default.jpg`;
        const size = '100';
        viewer.open({
            type: 'image',
            url:  url,
            buildPyramid: false
        });
    }
    
    /**
     * Load the user's rank and score.
     * Assumes that the current user's name has been added to currentUserName before this template was rendered.
     */
    function loadUserProgress() {
        if (!currentUserName) {
            return
        }
        $.ajax({
            url: '/leaderboard/',
            dataType: 'json',
            contentType: 'application/json',
            data: '{}'
        }).done(function(data) {
            for (let user of data.top_users) {
                if (user.name == currentUserName) {
                    $('#rank').append(user.rank);
                    $('#score').html(user.score);
                }
            }
        });
    }
    
    /**
     * Return an array of image rectangles from the current overlays.
     */
    function getOverlaysAsImageRectangles() {
        return viewer.currentOverlays.map(function(overlay) {
            let bounds = overlay.getBounds(viewer.viewport),
                vpRect = new OpenSeadragon.Rect(bounds.x, bounds.y, bounds.width, bounds.height, bounds.degrees);
            return viewer.viewport.viewportToImageRectangle(vpRect);
        });
    }

    /**
     * Draw an overlay from a selection.
     */
    function drawOverlay(s) {
        let elem   = document.createElement("div"),
            vpRect = viewer.viewport.imageToViewportRectangle(s);
        elem.className = 'overlay';
        elem.id = overlayID;
        let overlay = {
            element: elem,
            location: new OpenSeadragon.Rect(vpRect.x, vpRect.y, vpRect.width, vpRect.height, vpRect.degrees)
        }
        viewer.addOverlay(overlay);
        overlays[overlayID] = overlay;
        overlayID += 1;
    }
    
    /**
     * Convert an overlay back to a selection box on click.
     */
    $('#openseadragon').on('click', '.overlay', function() {
        const id      = $(this).attr('id'),
              overlay = viewer.getOverlayById(id),
              bounds  = overlay.getBounds(viewer.viewport);
        viewer.removeOverlay(id);
        selector.rect = new OpenSeadragon.SelectionRect(bounds.x, bounds.y, bounds.width, bounds.height, bounds.degrees);
        selector.draw();
        selector.enable();
    });
    
    /**
     * Draw an overlay when a selection is confirmed.
     */
    viewer.addHandler('selection', function(s) {
        drawOverlay(s);
    });

    /**
     * Handle a faliure to open an image
     */
    viewer.addHandler('open-failed', function(evt) {
        notify(evt.message, 'error');
    });
    
    /**
     * Toggle icon for toggle selection button.
     */
    viewer.addHandler('selection_toggle', function(evt) {
        if (evt.enabled) {
            $('#toggle-selection span').addClass('fa-toggle-on');
            $('#toggle-selection span').removeClass('fa-toggle-off');
        } else {
            $('#toggle-selection span').removeClass('fa-toggle-on');
            $('#toggle-selection span').addClass('fa-toggle-off');
        }
        $('#toggle-selection').blur();
    });

   /**
    * Load the task.
    */
    pybossa.taskLoaded(function(task, deferred) {
        deferred.resolve(task);
    });

    /**
     * Present the task.
     */
    pybossa.presentTask(function(task, deferred) {
        if (!$.isEmptyObject(task)) {
            const recordURL = `http://primocat.bl.uk/F/?func=direct&doc_number=${task.info.aleph_sys_no}`;
            $('#record_url').html();
            $('#task-id').html(task.id);
            $('#help').prepend(task.info.help);
            $('#question').html(task.info.question);
            $('#example').popover({
                trigger: 'focus',
                placement: 'left',
                html: true,
                content: `<div><img src="${task.info.example}" width="300" class="mb-4"></div>`
            });
            loadImage(task.info.image_ark);
            loadUserProgress();

            $('.btn-answer').off('click').on('click', function() {
                task.answer = {
                    category: task.info.category,
                    image_ark: task.info.image_ark,
                    lark: task.info.ldark,
                    color: task.info.color,
                    aleph_sys_no: task.info.aleph_sys_no,
                    coordinates: getOverlaysAsImageRectangles()
                };

                console.log(JSON.stringify(task.answer, null, 2));

/**
                pybossa.saveTask(task.id, task.answer).done(function() {
                    deferred.resolve();
                    notify('Answer saved, thanks!', 'success');
                }).fail(function(xhr, status, error) {
                    logError(new Error(error));
                });
                
                */
            });
        } else {
          $("#project-content").hide();
          notify('Congratulations! You have contributed to all available tasks!', 'success');
        }
    });
    pybossa.run('project-playbills-mark');
</script>