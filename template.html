<style>
    #openseadragon {
        font-size: 0.9rem;
        height: 60vh;
    }
    .openseadragon-message {
        color: #FFF;
    }
    #answer-column {
        overflow-y: auto;
    }
    @media (min-width: 768px) {
        #openseadragon {
            height: 100%;
        }
    }
</style>
<div id="project-content" class="bg-faded d-flex flex-column h-100">
    <div class="w-100 h-100">
        <div id="openseadragon">
        </div>
    </div>
</div>
<script>
    let lcViewerInterface = new LibCrowdsViewerInterface({ id: 'openseadragon', selectionEnabled: true });
    lcViewerInterface.selector.enable();
    $('#openseadragon').prepend($('.navbar'))
    
    /**
     * Add the question and answer sidebar to the viewer.
     */
    function buildTaskSidebar(task) {
        let elem = $(`<h3 class="lead text-center">${task.info.question}</h3>
                      <p>${task.info.help}</p>
                      <div class="text-center mb-2">
                          <a href="../tutorial" class="btn btn-outline-info mt-2" role="button">Tutorial</a>
    			          <button class="btn btn-outline-success btn-answer mt-2" role="button">
                              <span class="fa fa-floppy-o mr-1"></span>Save
                          </button>
                      </div>`);
        lcViewerInterface.loadSidebar('Task', elem);
    }
    
    /**
     * Add the user progress sidebar to the viewer.
     */
    function buildProgressSidebar() {
        let elem = $('<p></p>');
        getUserRankAndScore().done(function(data) {
            if (data) {
                elem.append(`<p><span class="fa fa-trophy mr-2"></span>Rank ${data.rank}</p>
                             <p class="mb-0"><span class="fa fa-tasks mr-2"></span>${data.score} contributions</p>`);
            } else {
                elem.append('<small><a href="../../account/signin">Sign in</a> to see your rank and score</small>');
            }
            lcViewerInterface.loadSidebar('Progress', elem);
        });
    }

   /**
    * Load the task.
    */
    pybossa.taskLoaded(function(task, deferred) {
        deferred.resolve(task);
    });

    /**
     * Present the task.
     */
    pybossa.presentTask(function(task, deferred) {
        if (!$.isEmptyObject(task)) {
            lcViewerInterface.loadImage(task.info.image_ark);
            lcViewerInterface.removeSidebars();
            buildTaskSidebar(task);
            buildProgressSidebar();

            $('.btn-answer').off('click').on('click', function() {
                task.answer = {
                    category: task.info.category,
                    image_ark: task.info.image_ark,
                    aleph_sys_no: task.info.aleph_sys_no,
                    coordinates: lcViewerInterface.getOverlaysAsImageRectangles()
                };

                console.log(JSON.stringify(task.answer, null, 2));

                pybossa.saveTask(task.id, task.answer).done(function() {
                    deferred.resolve();
                    notify('Answer saved, thanks!', 'success');
                }).fail(function(xhr, status, error) {
                    logError(new Error(error));
                });
            });
        } else {
          $("#project-content").hide();
          notify('Congratulations! You have contributed to all available tasks!', 'success');
        }
    });
    pybossa.run('project-playbills-mark');
</script>