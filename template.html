<style>
    #openseadragon {
        height: 60vh;
        background-color: #000000;
    }
    .btn {
        cursor: pointer;
    }
    #navigation-buttons {
        position: absolute;
        z-index: 2;
    }
    #answer-column {
        overflow-y: auto;
    }
    .selection,
    .selection-box {
        border-width: 2px !important;
        border-style: solid !important;
    }
    .selection {
        opacity: .75;
    }
    .selection:hover,
    .selection.focus {
        background-color: rgba(0, 0, 0, 0.5);
    }
    .btn-mark:before {
        font-family: FontAwesome;
        content: '\f10c'
    }
    .btn-mark.active:before {
        content: '\f111'
    }
    .btn-mark:after {
        content: ''
    }
    .text-initial {
        color: initial;
    }
    @media (min-width: 768px) {
        #openseadragon {
            height: 100%;
        }
    }
</style>

<div id="project-content" class="bg-faded container-fluid d-flex flex-column h-100">
    <div class="row">
    
        <!-- Viewer column -->
        <div class="col-sm-12 col-md-9 px-0">
            <div id="navigation-buttons" class="btn-group ml-2 mt-2">
                <button id="zoom-in" class="btn btn-secondary btn-sm"><span class="fa fa-search-plus"></span></button>
                <button id="zoom-out" class="btn btn-secondary btn-sm"><span class="fa fa-search-minus"></span></button>
                <button id="home" class="btn btn-secondary btn-sm"><span class="fa fa-home"></span></button>
                <button id="full-page" class="btn btn-secondary btn-sm"><span class="fa fa-expand"></span></button>
            </div>
            <div id="openseadragon"></div>
        </div>
        
        <!-- Question and answer column -->
        <div id="answer-column" class="col-sm-12 col-md-3 text-center py-3">
            <p>
                Click on a category below to annotate.
            </p>
            <hr>
            <div id="annotation-buttons" class="text-center">
                <button data-category="title" data-color="#2ecc71" class="btn btn-secondary btn-sm btn-block btn-mark d-flex align-items-center justify-content-between">
                    <span class="text-initial">Title</span>
                </button>
                <button data-category="playwright" data-color="#9b59b6" class="btn btn-secondary btn-sm btn-block btn-mark d-flex align-items-center justify-content-between">
                    <span class="text-initial">Playwright</span>
                </button>
                <button data-category="director" data-color="#34495e" class="btn btn-secondary btn-sm btn-block btn-mark d-flex align-items-center justify-content-between">
                    <span class="text-initial">Director</span>
                </button>
                <button data-category="venue" data-color="#f1c40f" class="btn btn-secondary btn-sm btn-block btn-mark d-flex align-items-center justify-content-between">
                    <span class="text-initial">Venue</span>
                </button>
                <button data-category="actor" data-color="#3498db" class="btn btn-secondary btn-sm btn-block btn-mark d-flex align-items-center justify-content-between">
                    <span class="text-initial">Actor and Role</span>
                </button>
                <button data-category="dates" data-color="#e74c3c" class="btn btn-secondary btn-sm btn-block btn-mark d-flex align-items-center justify-content-between">
                    <span class="text-initial">Dates</span>
                </button>
                <button data-category="production-staff" data-color="#e67e22" class="btn btn-secondary btn-sm btn-block btn-mark d-flex align-items-center justify-content-between">
                    <span class="text-initial">Production Staff and Role</span>
                </button>
            <hr>
                <button class="btn btn-success btn-sm btn-answer text-center"><span class="fa fa-floppy-o"></span> Mark as Complete</button>
                <hr>
                <p class="mt-2"><small>You are working on task: <span id="task-id" class="badge badge-info"></span></small></p>
                <p><a href="../tutorial"><small><span class="fa fa-book"></span> Tutorial</small></a></p>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://cdn.socket.io/socket.io-1.3.7.js"></script>
<script>
    let taskID = null;
    const table = 'selection';
    
    /**
     * A class for interacting with the RethinkDB database.
     */
    class DatabaseClient {
        
        /**
         * Make a request.
         */
        static request(method, endpoint, data, callback) {
            const baseURL = `/rethinkdb/${table}/`;
            $.ajax({
                type: method,
                contentType: "application/json; charset=utf-8",
                url: baseURL + endpoint,
                data: data,
                dataType: "json",
                success: function(result) {
                    if (result === null) {
                        notify('Result not found, has it just been deleted?', 'warning');
                    } else if (result.errors) {
                        logError(new Error(result.first_error), true);
                    } else if (typeof callback !== 'undefined') {
                        callback(result);    
                    }
                },
                error: function(err) {
                    logError(err, true);
                }
            });
        }
        
        /** 
         * Save some record data.
         */
        static save(data) {
            DatabaseClient.request('POST', `${taskID}/insert`, JSON.stringify([data]));
        }
        
        /** 
         * Load a single record.
         */
        static load(primary_key, callback) {
            DatabaseClient.request('GET', `get/${primary_key}`, primary_key, callback);
        }
        
        /**
         * Delete a record.
         */
        static remove(primary_key, callback) {
            DatabaseClient.request('DELETE', `${taskID}/delete/${primary_key}`, null, callback);
        }
        
        /** 
         * Filter records.
         */
        static filter(data, callback) {
            DatabaseClient.request('GET', 'filter', data, callback);
        }
        
        /** 
         * Update records.
         */
        static update(primary_key, data, callback) {
            DatabaseClient.request('PUT', `${taskID}/update/${primary_key}`, data, callback);
        }
        
        /**
         * Subscribe to the project's event stream and handle changes.
         */
        static subscribe() {
            const origin  = window.location.origin,
                  url     = `${origin}/rethinkdb/${table}/subscribe`,
                  source  = new EventSource(url);
            source.onmessage = function (msg) {
                const data = JSON.parse(msg.data);
                if (data.old_val !== null && data.new_val !== null) {
                    console.log('record updated');
                    // Record updated
                } else if (data.new_val !== null && data.new_val.task_id == taskID) {
                    console.log('record added');
                    drawSelections([data.new_val]);  // Record added
                } else if (data.old_val.task_id !== null && data.old_val.task_id == taskID) {
                    console.log('record removed');
                    $(`#${data.old_val.id}`).remove();  // Record removed
                }
            };
        }
    }
    
    class Selector {
        
    }
    
    const viewer = OpenSeadragon({
        id: "openseadragon",
        prefixUrl: "/static/img/openseadragon/",
        zoomInButton:   "zoom-in",
        zoomOutButton:  "zoom-out",
        homeButton:     "home",
        fullPageButton: "full-page",
        showNavigator: true,
        navigatorPosition: 'BOTTOM_RIGHT',
        homeFillsViewer: true,
        minZoomLevel: 0.2,
        gestureSettingsMouse: {
            clickToZoom: false
        },
        gestureSettingsTouch: {
            clickToZoom: false
        },
        gestureSettingsPen: {
            clickToZoom: false
        }
    });
    
    const selector = viewer.selection({
        prefixUrl: "/static/img/openseadragonselection/",
        restrictToImage: true
    });
    
    // Subscribe to project's the public event stream.
    DatabaseClient.subscribe();
    
    /**
     * Load an image into the viewer.
     */ 
    function loadImage(imageURL) {
        viewer.open({
            type: 'image',
            url:  imageURL,
            buildPyramid: false
        });
    }
    
    /**
     * Create record data from a selection.
     */
    function createRecordDataFromSelection(s) {
        const args         = [s.x, s.y, s.width, s.height, s.degrees],
              imageRect    = new OpenSeadragon.Rect(...args),
                viewportRect = viewer.viewport.imageToViewportRectangle(imageRect);
              data         = {
                  category:     $('.btn-mark.active').data('category'),
                  color:        $('.btn-mark.active').data('color'),
                  imageRect:    imageRect,
                  viewportRect: viewportRect
            };
        return data;
    }
    
    /**
     * Draw a list of selections.
     */
    function drawSelections(selections) {
        for (let s of selections) {
            let elem = document.createElement("div");
            elem.id = s.id;
            elem.className = "selection";
            elem.style.borderColor = s.data.color;
            $(`#${s.id}`).remove();
            viewer.addOverlay({
                element: elem,
                location: new OpenSeadragon.Rect(s.data.viewportRect.x,
                                                 s.data.viewportRect.y,
                                                 s.data.viewportRect.width,
                                                 s.data.viewportRect.height)
            });
        }
    }
    
    /**
     * Convert a selection back to a selection-box on click.
     */
    $('#openseadragon').on('click', '.selection', function() {
        const primary_key = $(this).attr('id'),
              callback    = function(record) {
                  const pk   = record.id,
                        cat  = record.data.category,
                        r    = record.data.viewportRect,
                        args = [r.x, r.y, r.width, r.height, r.degrees];
                  selector.current_record = record;
                  selector.rect = new OpenSeadragon.SelectionRect(...args);
                  $(`.btn-mark[data-category="${cat}"]:not(.active)`).click();
                  $(`#${pk}`).hide();
                  selector.draw();
              };
        DatabaseClient.load(primary_key, callback);
    });
    
    /**
     * Handle a faliure to open an image
     */
    viewer.addHandler('open-failed', function(evt) {
        notify(evt.message, 'error');
    });
    
    /**
     * Handle a selection being created/updated.
     */
    viewer.addHandler('selection', function(s) {
        const selection = createRecordDataFromSelection(s);
        if (selector.current_record) {
            const primary_key = selector.current_record.id;
            DatabaseClient.update(primary_key, selection);
			selector.current_record = null;
        } else {
            DatabaseClient.save(selection);
        }
    });
    
    /**
     * Handle a selection being canceled/destroyed.
     */
    viewer.addHandler('selection_cancel', function() {
        if (selector.current_record) {
			const primary_key = selector.current_record.id;
            DatabaseClient.remove(primary_key);
			selector.current_record = null;
        }
    });
    
    /**
     * Enable/disable selector when a mark button is clicked.
     */
    $('.btn-mark').on('click', function() {
        $('.btn-mark.active').not(this).removeClass('active');
        $(this).toggleClass('active');
        if ($('.btn-mark.active').length) {
            const color = $('.btn-mark.active').data('color'),
                  style = `.selection-box { border-color: ${color} !important; }`;
            $("<style>").text(style).appendTo("head");
            selector.enable();
        } else {
            selector.disable();
        }
    });
    
    /**
     * Load the mark button colours.
     */
    $('.btn-mark').each(function() {
        $(this).css('color', $(this).data('color'));
    });
  
   /**
    * Load the task.
    */
    pybossa.taskLoaded(function(task, deferred) {
        deferred.resolve(task);
    });
  
    /**
     * Present the task.
     */ 
    pybossa.presentTask(function(task, deferred) {
        if (!$.isEmptyObject(task)) {
            $('#task-id').html(task.id);
            taskID = task.id;
            loadImage(task.info.url_b);
            const params = {task_id: task.id};
            viewer.addHandler('open', function() {
                DatabaseClient.filter(params, drawSelections);
            });
            
            $('.btn-answer').off('click').on('click', function() {
                const saveCallback = function(selections) {
                    task.answer = {
                        selections: selections
                    };
                    
                    console.log(JSON.stringify(task.answer, null, 2));
                    
                    pybossa.saveTask(task.id, task.answer).done(function() {
                        deferred.resolve();
                        notify('Answer saved, thanks!', 'success');
                    }).fail(function(xhr, status, error) {
                        logError(new Error(error));
                    });
                };
                DatabaseClient.filter(null, saveCallback);
            });
        } else {
          $("#project-content").hide();
          notify('Congratulations! You have contributed to all available tasks!', 'success');
        }
    });
    pybossa.run('project-annotate');
</script>